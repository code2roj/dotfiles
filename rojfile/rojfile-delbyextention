#!/bin/bash
# This script receives 2 arguments: a target directory and a file extension.
# It finds all files with the provided extension in the target directory
# and its subdirectories, and then interactively deletes them.

# --- Functions ---
usage() {
    echo "Usage: $(basename "$0") <target_directory> <file_extension>"
    echo "Example: $(basename "$0") /path/to/docs tmp"
    exit 1
}

# --- Main Script ---

# Check if the correct number of arguments is provided
if [ "$#" -ne 2 ]; then
    echo "Error: Incorrect number of arguments." >&2
    usage
fi

target_dir="$1"
file_extension="$2"

# Check if the target directory exists
if [ ! -d "$target_dir" ]; then
    echo "Error: The target directory '$target_dir' does not exist." >&2
    exit 1
fi

# Sanitize the file extension by removing a leading dot, if present.
file_extension="${file_extension#.}"

echo "Searching for files with extension '.${file_extension}' in '${target_dir}' and its subdirectories..."

# Find files and store them in an array. Using -print0 and mapfile is safe
# for filenames with spaces, newlines, or other special characters.
mapfile -d '' files_to_delete < <(find "$target_dir" -type f -name "*.${file_extension}" -print0)

file_count=${#files_to_delete[@]}

# Exit if no files were found
if [ "$file_count" -eq 0 ]; then
    echo "No files with extension '.${file_extension}' found."
    exit 0
fi

echo "Found ${file_count} file(s) to be deleted:"
printf '%s\n' "${files_to_delete[@]}"
echo

# Confirmation prompt
echo "ATTENTION: This action is IRREVERSIBLE."
read -p "Are you sure you want to delete all these files? (y/N) " -n 1 -r answer
echo # Move to a new line

if [[ ! "$answer" =~ ^[Yy]$ ]]; then
    echo "Operation cancelled by user."
    exit 0
fi

echo "Deleting files, please wait..."

# Use xargs with -0 to safely handle the list of files for deletion.
# The `printf` is a safe way to pass the array to xargs.
printf '%s\0' "${files_to_delete[@]}" | xargs -0 rm -f

# Check the exit code of the last command (rm)
if [ $? -eq 0 ]; then
    echo "Successfully deleted ${file_count} file(s)."
else
    echo "Error: An error occurred during deletion. Some files may not have been deleted." >&2
    exit 1
fi
