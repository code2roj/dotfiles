#!/bin/bash

DATE=$(date +%Y-%m-%d-%H-%M-%S)
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
REPORT_FILE="$HOME/Downloads/report-$DATE.rojfile"
touch "$REPORT_FILE"


DOWNLOAD_DIR="$HOME/Downloads"
DEST_PARENT_DIR="/media/mydata/ROJ_2/1-filebase/"

LARGE_FILES_DIR="$DOWNLOAD_DIR/large_files-check_them"

# Check if the destination directory exists
if [ ! -d "$DEST_PARENT_DIR" ]; then
    echo "$TIMESTAMP    Error: Destination directory $DEST_PARENT_DIR does not exist." >> "$REPORT_FILE"
    exit 1
fi

# Check if the source directory exists
if [ ! -d "$DOWNLOAD_DIR" ]; then
    echo "$TIMESTAMP    Error: Source directory $DOWNLOAD_DIR does not exist." >> "$REPORT_FILE"
    exit 1
fi

# Move files larger than 50MB to large_files-check_them
mkdir -p "$LARGE_FILES_DIR"
echo "$TIMESTAMP    Checking for files larger than 50MB in $DOWNLOAD_DIR" >> "$REPORT_FILE"
find "$DOWNLOAD_DIR" -type f -size +50M -not -path "$LARGE_FILES_DIR/*" | while read -r FILE; do
    if mv "$FILE" "$LARGE_FILES_DIR/"; then
        echo "$TIMESTAMP    $FILE moved to large_files-check_them due to its large size" >> "$REPORT_FILE"
    else
        echo "$TIMESTAMP    Error: Failed to move $FILE to large_files-check_them" >> "$REPORT_FILE"
    fi
done



# Rename files with uppercase extensions to lowercase (up to 5th level)
echo "$TIMESTAMP    Starting file extension renaming in $DOWNLOAD_DIR" >> "$REPORT_FILE"
find "$DOWNLOAD_DIR" -maxdepth 5 -type f -name '*.*' -not -path "$LARGE_FILES_DIR/*" | while read -r FILE; do
    filename=$(basename "$FILE")
    file_extension="${filename##*.}"
    if [[ "$file_extension" =~ [A-Z] ]]; then
        lower_ext=$(echo "$file_extension" | tr '[:upper:]' '[:lower:]')
        new_file="${FILE%.*}.$lower_ext"
        if mv "$FILE" "$new_file"; then
            echo "$TIMESTAMP    Renamed $FILE to $new_file" >> "$REPORT_FILE"
        else
            echo "$TIMESTAMP    Error: Failed to rename $FILE to $new_file" >> "$REPORT_FILE"
        fi
    fi
done

# Define extensions to ignore
IGNORE_EXTENSIONS=("rojfile" "tmp" "part" "crdownload" "download" "exe" "zip" "tar" "gz" "bz2" "xz" "7z" "rar" "iso" "img")
FOLDER_IGNORE_EXTENSIONS=("iso" "img")

# Build SKIP_FOLDERS, including large_files-check_them
declare -A SKIP_FOLDERS
SKIP_FOLDERS["$LARGE_FILES_DIR"]=1
while IFS= read -r -d '' folder; do
    for ext in "${FOLDER_IGNORE_EXTENSIONS[@]}"; do
        if find "$folder" -maxdepth 4 -type f -iname "*.${ext}" | grep -q .; then
            SKIP_FOLDERS["$folder"]=1
            break
        fi
    done
done < <(find "$DOWNLOAD_DIR" -type d -not -path "$LARGE_FILES_DIR/*" -print0)

# Process remaining files
COUNTER=0
while read -r FILE; do
    echo "$TIMESTAMP    Found file: $FILE" >> "$REPORT_FILE"
    file_dir=$(dirname "$FILE")
    if [[ ${SKIP_FOLDERS["$file_dir"]+_} ]]; then
        echo "$TIMESTAMP    Skipping $FILE (folder contains ignored extension or is large_files-check_them)" >> "$REPORT_FILE"
        continue
    fi

    filename=$(basename "$FILE")
    rel_path=${FILE#"$DOWNLOAD_DIR/"}
    rel_dir=$(dirname "$rel_path")

    # Extract file extension
    file_extension="${filename##*.}"
    if [ "$filename" = "$file_extension" ]; then
        echo "$TIMESTAMP    Skipping $FILE (no extension)" >> "$REPORT_FILE"
        continue
    fi

    # Skip if file extension is in IGNORE_EXTENSIONS
    for ignore_ext in "${IGNORE_EXTENSIONS[@]}"; do
        if [[ "$file_extension" == "$ignore_ext" ]]; then
            echo "$TIMESTAMP    Skipping $FILE (ignored extension)" >> "$REPORT_FILE"
            continue 2
        fi
    done

    # Extract prefix (sub-category) before first '-'
    file_prefix=$(echo "$filename" | cut -d '-' -f1)
    file_sub_category="${file_prefix:-uncategorized}"

    # Do NOT preserve original folder structure
    dest_dir="$DEST_PARENT_DIR/$file_extension/$file_sub_category"

    if [ ! -d "$dest_dir" ]; then
        if mkdir -p "$dest_dir"; then
            echo "$TIMESTAMP    Created directory: $dest_dir" >> "$REPORT_FILE"
        else
            echo "$TIMESTAMP    Error: Could not create directory $dest_dir" >> "$REPORT_FILE"
            exit 1
        fi
    fi

    rand_str=$(tr -dc 'A-Za-z0-9' </dev/urandom | head -c 6)
    base="${filename%.*}"
    new_filename="${base}_${rand_str}.${file_extension}"

    if mv "$FILE" "$dest_dir/$new_filename"; then
        echo "$TIMESTAMP    Moved $FILE to $dest_dir/$new_filename" >> "$REPORT_FILE"
        COUNTER=$((COUNTER + 1))
    else
        echo "$TIMESTAMP    Error moving $FILE to $dest_dir/$new_filename" >> "$REPORT_FILE"
    fi
done < <(find "$DOWNLOAD_DIR" -type f -not -path "$LARGE_FILES_DIR/*")

echo "$TIMESTAMP    Successfully moved $COUNTER file(s)." >> "$REPORT_FILE"

# Remove empty directories (including those containing only empty subdirectories)
find "$DOWNLOAD_DIR" -depth -type d -not -path "$LARGE_FILES_DIR" -not -path "$LARGE_FILES_DIR/*" | while read -r DIR; do
    if [ "$(find "$DIR" -mindepth 1 -type f | wc -l)" -eq 0 ]; then
        if rmdir "$DIR"; then
            echo "$TIMESTAMP    Removed empty directory: $DIR" >> "$REPORT_FILE"
        fi
    fi
done
echo "$TIMESTAMP    Finished organizing downloads." >> "$REPORT_FILE"
