#!/bin/bash

# ============================================================================
# Background Removal Script using rembg
# ============================================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VENV_DIR="$HOME/.rojimg-venv"
REQUIREMENTS_FILE="${SCRIPT_DIR}/rojimg-venv-requirements.txt"
VENV_PYTHON="${VENV_DIR}/bin/python"
VENV_PIP="${VENV_DIR}/bin/pip"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

print_error() { echo -e "${RED}Error: $1${NC}" >&2; }
print_success() { echo -e "${GREEN}$1${NC}"; }
print_info() { echo -e "${YELLOW}$1${NC}"; }

check_python() {
    if ! command -v python3 &> /dev/null; then
        print_error "Python 3 is not installed. Please install Python 3.10 or higher."
        exit 1
    fi
    local python_version=$(python3 -c 'import sys; print(".".join(map(str, sys.version_info[:2])))')
    print_info "Found Python ${python_version}"
}

create_venv() {
    if [ ! -d "${VENV_DIR}" ]; then
        print_info "Creating virtual environment: ${VENV_DIR}"
        python3 -m venv "${VENV_DIR}"
        if [ $? -ne 0 ]; then
            print_error "Failed to create virtual environment"
            exit 1
        fi
        print_success "Virtual environment created successfully"
        print_info "Upgrading pip..."
        "${VENV_PIP}" install --upgrade pip > /dev/null 2>&1
    else
        print_info "Virtual environment already exists: ${VENV_DIR}"
    fi
}

install_dependencies() {
    if [ ! -f "${REQUIREMENTS_FILE}" ]; then
        print_error "Requirements file not found: ${REQUIREMENTS_FILE}"
        print_info "Creating default requirements file..."
        cat > "${REQUIREMENTS_FILE}" << 'EOF'
rembg[cli]
pillow
onnxruntime
EOF
        print_success "Requirements file created"
    fi
    print_info "Installing dependencies from ${REQUIREMENTS_FILE}..."
    "${VENV_PIP}" install -r "${REQUIREMENTS_FILE}" > /dev/null 2>&1
    if [ $? -ne 0 ]; then
        print_error "Failed to install dependencies"
        exit 1
    fi
    print_success "Dependencies installed successfully"
}

check_model_downloaded() {
    local model_name="$1"
    local model_dir="${HOME}/.u2net"
    if [ -d "${model_dir}" ]; then
        if ls "${model_dir}"/*"${model_name}"*.onnx 1> /dev/null 2>&1 || \
           ls "${model_dir}"/*"${model_name}"*.pth 1> /dev/null 2>&1; then
            return 0
        fi
    fi
    return 1
}

download_model() {
    local model_name="$1"
    if check_model_downloaded "${model_name}"; then
        print_info "Model ${model_name} is already downloaded"
        return 0
    fi
    print_info "Downloading model: ${model_name}..."
    "${VENV_PYTHON}" << EOF
import sys
try:
    from rembg import new_session
    print("Initializing session for model: ${model_name}")
    session = new_session("${model_name}")
    print("Model ${model_name} downloaded successfully")
    sys.exit(0)
except Exception as e:
    print(f"Error downloading model: {e}", file=sys.stderr)
    sys.exit(1)
EOF
    if [ $? -eq 0 ]; then
        print_success "Model ${model_name} downloaded successfully"
        return 0
    else
        print_error "Failed to download model ${model_name}"
        return 1
    fi
}

check_and_download_models() {
    local models=("birefnet-massive" "birefnet-portrait" "isnet-anime")
    print_info "Checking required models..."
    for model in "${models[@]}"; do
        download_model "${model}"
    done
}

usage() {
    cat << EOF
Usage: $0 <image_file> [-h|-a]

Remove background from an image using rembg AI models.

Arguments:
    <image_file>    Path to the input image file (required)

Options:
    -h              Use birefnet-portrait model (for human portraits)
    -a              Use isnet-anime model (for anime characters)
    (default)       Use birefnet-massive model (general purpose)

Examples:
    $0 photo.jpg                    # Default model
    $0 portrait.png -h              # Portrait model
    $0 anime_character.jpg -a       # Anime model

Output:
    Images saved in 'removed_bgs' folder with format: filename_nobg_HHMMSS.png

EOF
    exit 1
}

process_image() {
    local input_file="$1"
    local model="$2"
    if [ ! -f "${input_file}" ]; then
        print_error "Input file does not exist: ${input_file}"
        exit 1
    fi
    local input_dir="$(dirname "$(realpath "${input_file}")")"
    local input_basename="$(basename "${input_file}")"
    local input_name="${input_basename%.*}"
    local output_dir="${input_dir}/removed_bgs"
    if [ ! -d "${output_dir}" ]; then
        print_info "Creating output directory: ${output_dir}"
        mkdir -p "${output_dir}"
    fi
    local timestamp=$(date +%H%M%S)
    local output_file="${output_dir}/${input_name}_nobg_${timestamp}.png"
    print_info "Processing image with model: ${model}"
    print_info "Input:  ${input_file}"
    print_info "Output: ${output_file}"
    "${VENV_PYTHON}" << EOF
import sys
from pathlib import Path
try:
    from rembg import remove, new_session
    from PIL import Image
    print("Loading model: ${model}")
    session = new_session("${model}")
    print("Opening input image...")
    input_image = Image.open("${input_file}")
    print("Removing background...")
    output_image = remove(input_image, session=session)
    print("Saving output image...")
    output_image.save("${output_file}", "PNG")
    print("Processing completed successfully!")
    sys.exit(0)
except Exception as e:
    print(f"Error processing image: {e}", file=sys.stderr)
    import traceback
    traceback.print_exc()
    sys.exit(1)
EOF
    if [ $? -eq 0 ]; then
        print_success "Background removed successfully!"
        print_success "Output saved to: ${output_file}"
    else
        print_error "Failed to process image"
        exit 1
    fi
}

# Main execution
if [ $# -eq 0 ] || [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
    if [ $# -eq 0 ]; then
        print_error "No input file specified"
    fi
    usage
fi

INPUT_FILE="$1"
MODEL="birefnet-massive"
shift

while [ $# -gt 0 ]; do
    case "$1" in
        -h) MODEL="birefnet-portrait"; shift ;;
        -a) MODEL="isnet-anime"; shift ;;
        *) print_error "Unknown option: $1"; usage ;;
    esac
done

echo "============================================================================"
echo "  Background Removal Script using rembg"
echo "============================================================================"
echo ""

print_info "Step 1: Checking Python installation..."
check_python
echo ""

print_info "Step 2: Setting up virtual environment..."
create_venv
echo ""

print_info "Step 3: Installing dependencies..."
install_dependencies
echo ""

print_info "Step 4: Checking and downloading models..."
check_and_download_models
echo ""

print_info "Step 5: Processing image..."
process_image "${INPUT_FILE}" "${MODEL}"
echo ""

echo "============================================================================"
print_success "All operations completed successfully!"
echo "============================================================================"

exit 0
