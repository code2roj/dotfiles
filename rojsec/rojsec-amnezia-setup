#!/bin/bash
# Corrected AmneziaWG Server Setup Script
# Fixes:
# - Dynamically detects the correct outbound network interface (instead of hardcoding eth0)
# - Sets UFW forwarding policy to ACCEPT (critical for internet routing)
# - Makes NAT rule addition idempotent (won't duplicate if script is rerun)
# - Sets forwarding policy idempotently
# - Adds helpful echo messages for transparency
# - Reloads UFW at the end for immediate application
set -euo pipefail

# 1. Install AmneziaWG and dependencies
add-apt-repository -y ppa:amnezia/ppa
apt update && apt install -y amneziawg qrencode ufw

# 2. Config directory & keys
mkdir -p /etc/amnezia/amneziawg
cd /etc/amnezia/amneziawg
umask 077
PRIV=$(awg genkey)
PUB=$(echo "$PRIV" | awg pubkey)

# 3. Server Configuration (awg0.conf)
cat > /etc/amnezia/amneziawg/awg0.conf << EOF
[Interface]
Address = 10.66.66.1/24
PrivateKey = $PRIV
ListenPort = 1987
Jc = 4
Jmin = 40
Jmax = 70
S1 = 45
S2 = 60
H1 = 1
H2 = 2
H3 = 3
H4 = 4
EOF

# 4. Enable IP forwarding (kernel level)
echo "net.ipv4.ip_forward=1" > /etc/sysctl.d/99-vpn.conf
sysctl -p /etc/sysctl.d/99-vpn.conf

# Detect outbound interface (the one used for internet traffic)
IFACE=$(ip route get 8.8.8.8 | awk '{print $5; exit}')
echo "Detected outbound interface: $IFACE"

# Add NAT masquerading via UFW (only if not already present)
if ! grep -q "*nat" /etc/ufw/before.rules; then
    sed -i "1i *nat\n:POSTROUTING ACCEPT [0:0]\n-A POSTROUTING -s 10.66.66.0/24 -o $IFACE -j MASQUERADE\nCOMMIT\n" /etc/ufw/before.rules
    echo "Added NAT masquerading rule for interface $IFACE"
else
    echo "NAT rule already present (skipping)"
fi

# Set UFW default forwarding policy to ACCEPT (only if still DROP)
if grep -q 'DEFAULT_FORWARD_POLICY="DROP"' /etc/default/ufw; then
    sed -i 's/DEFAULT_FORWARD_POLICY="DROP"/DEFAULT_FORWARD_POLICY="ACCEPT"/' /etc/default/ufw
    echo "Changed UFW forwarding policy to ACCEPT"
else
    echo "UFW forwarding policy already set to ACCEPT (skipping)"
fi

# 5. Firewall rules
ufw allow 22/tcp comment 'SSH'
ufw allow 1987/udp comment 'AmneziaWG'
ufw --force enable
ufw reload

# 6. Start and enable service
systemctl enable --now awg-quick@awg0

echo "=================================================="
echo "AmneziaWG server setup complete!"
echo "Outbound interface used: $IFACE"
echo "Server public key: $PUB"
echo "Now create clients with your add-user script."
echo "Test the connection â€” internet should now work through the VPN."
echo "=================================================="